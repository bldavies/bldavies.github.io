---
title: Habitat Choices of First-Generation Pokémon
layout: post
date: 2018-03-01 22:54:00 +1300
tags: igraph networks R Pokémon
---

I recently discovered R's [`igraph`](http://igraph.org) package for analysing networks and have been using it to explore the social behaviour of wild Pokémon as implied by their habitat choices.
This post documents and summarises some of my discoveries.
The source code and data are available on [GitHub](https://github.com/bldavies/pokenet).

## Matching species with their habitats

I identify species' habitats by where they can be randomly encountered in the international versions of Pokémon Red, Blue and Yellow.
Restricting to random encounters excludes starter Pokémon, species obtainable only through evolution, and 'special' encounters (e.g., the Electrodes inside the Kanto Power Plant and the legendary birds) from the sample.

I store the possible encounter events in a data frame named `encounters`, each row of which has three attributes:

1. the `location` at which the encounter occurs,
2. the `species` that is encountered and
3. the primary `type` of the encountered species.

Using these data, I define a species-location incidence matrix `habits` via

```r
habits <- table(encounters$species, encounters$location)
```

Each entry of `habits` is an indicator variable for the event in which a given species habitates in a given location.
Nonzero entries correspond to edges in the bipartite graph obtained by joining each species with its chosen habitats.

### Species' ubiquity

The rows and columns of `habits` provide count data on where different species habitate.
For example, summing the rows of `habits` yields the *ubiquity* of each species; that is, the number of locations in which each species habitates.
I store these sums in a data frame `pokemon` as follows.

```r
pokemon <- data.frame(species=rownames(habits),
                      ubiquity=rowSums(habits))
```

The boxplots below show the distribution of species' ubiquity according to their primary type.

![](https://raw.githubusercontent.com/bldavies/pokenet/master/images/ubiquity-distribution.svg?sanitize=true)

The three most ubiquitous species are Goldeen, Magikarp and Poliwag, each of which habitate in 24 distinct locations within the Kanto region.
All three have Water as their primary type.
Water-types have the highest median ubiquities, closely followed by Grass- and Normal-types.
The least ubiquitous types are Ghost, Fairy and Dragon; each species with one of these as their primary type habitates in only one location.

### Average diversity and ubiquity

The *diversity* of each location---that is, the number of different species that choose the location as a habitat---is obtained by summing the columns of `habits`.
I store these sums in a `locations` data frame as follows.

```r
locations <- data.frame(name=colnames(habits),
                        diversity=colSums(habits))
```

The average diversity of the locations in which each species habitates can be computed via

```r
pokemon$average_diversity <- colSums(t(habits) * locations$diversity) / pokemon$ubiquity
```

The `ubiquity` and `average_diversity` attributes provide information about the social preferences of different species.
For example, species that prefer to spread out across many small communities have high ubiquity and low average diversity, while the opposite is true for species that prefer to concentrate within a few large communities.
If all species fall into one of these two categories then we should observe a negative relationship between average diversity and ubiquity.
It happens that the correlation coefficient between the two attributes is about -0.22, suggesting that they indeed share a weak negative relationship.

However, closer inspection of the data reveals that this negative relationship is skewed by a large number of species that cohabitate in one or two locations.
The chart below plots species' average diversity against their ubiquity as well as the line that best fits the data in a least-squares sense.
Observations in this and all other charts are coloured by the corresponding species' primary type, and are plotted with a small amount of noise in order to reveal coincident points that would otherwise be hidden.

![](https://raw.githubusercontent.com/bldavies/pokenet/master/images/avgdiversity-ubiquity.svg?sanitize=true)

The top-left cluster in this chart comprises species that only habitate inside Cerulean Cave and/or the Kanto Safari Zone, which have respective diversities of 28 and 27.
These species have a strong positive effect on the average value of `average_diversity` among observations with low `ubiquity` values, driving the negative relationship between the two attributes as implied by the line of best fit.
Ignoring the top-left cluster of highly exclusive species, the chart above shows that the `average_diversity` and `ubiquity` vectors are almost orthogonal, and hence that species' social preferences are more complex than can be characterised by the two categories mentioned above.


## The cohabitation network

I extract more information about species' social behaviour by analysing their tendency to cohabitate.
My core assumption is that species reveal their preference toward socialising with other species through their choice of whether to share habitats; the more frequently two species cohabitate, the stronger is their social connection.

The number of locations in which two species cohabitate is given by the cross product of the corresponding two rows of `habits`.
I store these counts in a symmetric species-species adjacency matrix:

```r
cohabits <- habits %*% t(habits)
```

Each entry `cohabits[i, j]` is equal to the number of locations in which species `i` and `j` cohabitate, and each diagonal entry `cohabits[i, i] = diag(cohabits)[i]` is equal to the ubiquity of species `i`.
I interpret `cohabits` as the adjacency matrix for a weighted graph on the set of Pokémon species in which 

1. two species are adjacent if and only if they cohabitate, and
2. the weight of each edge is equal to the number of locations in which the two incident species cohabitate.

### Estimating the strength of species' social ties

The raw cohabitation counts are an imperfect measure of the strength of the social ties between species.
For example, ubiquitous species tend to have higher cohabitation counts with all other species and so appear to be more social.
However, having many social connections suggests that a species is "spreading itself thin" and hence that each of its connections are relatively weak.
Strong connections arise when two species spend lots of their time together and little of their time apart.

A convenient measure of the tendency for two species to spend most of their time in each others' company is the [Jaccard index](https://en.wikipedia.org/wiki/Jaccard_index)

$$ J_{ij}=\frac{c_{ij}}{u_i+u_j-c_{ij}}, $$

where \\(u_i\\) is the ubiquity of species \\(i\\), and where \\(c_{ij}\\) is number of locations in which species \\(i\\) and \\(j\\) cohabitate.
The Jaccard index \\(J_{ij}\\) is equal to ratio of the number of locations in which species \\(i\\) and \\(j\\) both habitate to the number of locations in which at least one habitates.
The index obtains its maximum value of 1 when species \\(i\\) and \\(j\\) cohabitate in a single location, and its minimum value of 0 when the two species never cohabitate.
The more that species \\(i\\) and \\(j\\) make similar habitat choices, the higher is \\(J_{ij}\\).
I define a function `jaccard` for computing Jaccard indices from an arbitrary cohabitation matrix `C` as follows.

```r
jaccard <- function (C) {
  Ui <- matrix(rep(diag(C), nrow(C)), ncol=nrow(C))
  Uj <- matrix(rep(diag(C), each=nrow(C)), ncol=nrow(C))
  J <- C / (Ui + Uj - C)
  return (J)
}
```

I define the cohabitation network as the weighted graph for which `jaccard(cohabits)` is the adjacency matrix:

```r
library(igraph)

net <- graph.adjacency(jaccard(cohabits), weighted=TRUE, mode="undirected")
net <- simplify(net)
```

The `simplify` command removes the loops in `net`.
These arise from the fact that the Jaccard index for each species with itself is equal to unity.

### Identifying the strongest connections

The cohabitation network `net` contains 1,549 (about 31.30%) of the 4,950 possible edges between its 100 vertices.
However, many of these edges have low weight and correspond to weak social connections between species, whereas I'm most interested in identifying which species share strong social connections.

I identify an edge-induced subgraph of `net` that represents the strongest social connections as follows.[^prod-space]
First, I find a maximum spanning forest (MSF) of `net`; that is, an edge-induced subgraph that

1. has the same vertex set as `net`,
2. has trees as components, and
3. obtains the maximum edge weight sum over all edge-induced subgraphs satisfying criteria 1 and 2.

The edges in the MSF form the 'backbone' of the cohabitation network and ensure that every species is connected with one of the species with which it most frequently cohabitates.
However, depending on the algorithm used, the MSF generally doesn't connect every species with its most frequent cohabitant and therefore doesn't necessarily contain the strongest connections in `net`.[^prim]
I therefore augment the MSF by taking its union with the subgraph obtained by choosing the edges in `net` of highest weight.

The number of edges with which to augment the MSF is chosen so that the average degree of each vertex in the augmented MSF is roughly equal to four.
This number turns out to be equal to the order of `net`.
To see why, let \\(E_\text{msf}\\) be the edge set for the MSF and let \\(E_\text{aug}\\) be the set of augmenting edges.
The augmented MSF has edge set \\(E=E_\text{msf}\cup E_\text{aug}\\) of size

$$
\begin{align}
    \lvert E\rvert
    &= \lvert E_\text{msf}\cup E_\text{aug}\rvert\\
    &\approx \lvert E_\text{msf}\rvert+\lvert E_\text{aug}\rvert\\
    &= \lvert V\rvert-1+\lvert E_\text{aug}\rvert,
\end{align}
$$

where \\(V\\) is the vertex set of `net`, and where the approximation in the second line arises from the fact that \\(E_\text{msf}\\) and \\(E_\text{aug}\\) may intersect.
If \\(\lvert E_\text{aug}\rvert=\lvert V\rvert\\) then, by the [Handshaking Lemma](https://en.wikipedia.org/wiki/Handshaking_lemma), the average vertex degree in `net` is equal to

$$
\begin{align}
    \frac{1}{\lvert V\rvert}\sum_{v\in V}\text{deg}(v)
    &= \frac{2\lvert E\rvert}{\lvert V\rvert}\\
    &\approx \frac{2(2\lvert V\rvert-1)}{\lvert V\rvert},
\end{align}
$$

which converges to four as \\(\lvert V\rvert\to\infty\\).

I define a function `augmented_msf` for identifying the augmented MSF of an igraph object `G` as follows.

```r
augmented_msf <- function (G) {
  E(G)$id <- seq(gsize(G))
  msf_ids <- E(mst(G, -E(G)$weight))$id
  cutoff <- quantile(E(G)$weight, (gsize(G) - gorder(G)) / gsize(G))[1]
  aug_ids <- which(E(G)$weight >= cutoff)
  aug_msf <- subgraph.edges(G, eids=E(G)[unique(c(msf_ids, aug_ids))])
  return (aug_msf)
}
```

The third and fourth lines in the definition of `augmented_msf` identify the edges of `G` with which to augment its MSF.
For example, if `G` has order 20 and size 100 then the MSF of `G` is augmented by adding those edges in `G` with weights equal to or greater than the weight of the edge at the 80th percentile.
This approach ends up adding 143 edges to the MSF of `net`, rather than the predicted 100, because the 100th highest-weight edge in `net` shares a weight of 0.5 with 128 other edges.

### Visualising the network

The augmented MSF of `net` contains 242 edges---producing an average vertex degree of 4.84---and is drawn below.
Each vertex is coloured according to the corresponding species' primary type and scaled according to that species' ubiquity.
I use [Fruchterman and Reingold (1991)](http://onlinelibrary.wiley.com/doi/10.1002/spe.4380211102/abstract;jsessionid=98D72B83F9358BACE49B25BC9A5BB5E1.f03t02)'s force-directed algorithm for determining vertices' layout.

![](https://raw.githubusercontent.com/bldavies/pokenet/master/images/augmented-msf.svg?sanitize=true)

The cohabitation network has two components: one large component of 98 different species and many types, and one isolated pair of Ground-types.
The latter contains Diglett and Dugtrio, which cohabitate exclusively in Diglett's Cave.
Water-types are most socially connected to other Water-types, suggesting that there are few amphibious species in the Kanto region that spend most of their time in the water.
Poison-types tend to be closely connected to Ground- and Rock-types, which are, presumably, immune to toxicity.

The augmented MSF reveals two large, densely connected clusters of low ubiquity species.
These clusters represent Cerulean Cave and the Kanto Safari Zone, and are directly bridged by Chansey, Parasect and Rhyhorn.
There is also a small cluster of Fire- and Poison-types that cohabitate inside Pokémon Mansion, as well as a clique of four Bug-types found in Viridian Forest.

## Estimating species' social influence

The structure of the cohabitation network reveals information about species' social influence.
A simple measure of such influence is the *degree centrality* of each species; that is, the number of other species with which each species cohabitates.
The `igraph` package makes it easy to compute this statistic:

```r
pokemon$degree <- degree(net)
```

The table below displays the species with the highest six degree centralities in the cohabitation network.
The three most connected species are, unsurprisingly, also the three most ubiquitous, and each cohabitate with 82 of the 99 other species in the sample.
These three species are highly social but, as shown by the relative sparsity of their incident edges in the visualisation of `net`, share weak social ties with their cohabitants.
Eight of the 10 most degree-central species are Water-types, with Ditto placing sixth and Venomoth placing seventh equal.

Species | Type | Degree
:--- |:--- | ---:
Goldeen | Water | 82
Magikarp | Water | 82
Poliwag | Water | 82
Krabby | Water | 69
Kingler | Water | 64
Ditto | Normal | 56

The *betweenness centrality* of each species measures the frequency with which that species lies on the shortest path between other species in the cohabitation network.
More betweenness-central species tend to have more control over the spread of rumors (and diseases!) due to their relative criticality within other species' communication channels.
I employ `igraph`'s method for computing betweenness centrality as follows.

```r
pokemon$betweenness <- betweenness(net, weights=rep(1, gsize(net)))
```

The six most betweenness-central species are tabulated below.
Goldeen, Magikarp and Poliwag are efficient messengers of information due to their high ubiquity.
Cubone takes fifth place due to it being the only species allowing Gastly and Haunter---both found exclusively inside Pokémon Tower---to communicate with species inside the Safari Zone.
Thirty species have betweenness centralities equal to zero.

Species | Betweenness
:--- | ---:
Goldeen | 269.15
Magikarp | 269.15
Poliwag | 269.15
Ditto | 202.20
Cubone | 190.00
Krabby | 169.77

The chart below compares species' betweenness and degree centralities.
With the exception of Cubone, more betweenness-central species tend to have more cohabitants.
Water-types are relatively inefficient at accumulating betweenness centrality when they expand their social network, whereas Electric-types appear to gain a relatively large amount of betweenness centrality per extra cohabitant.

![](https://raw.githubusercontent.com/bldavies/pokenet/master/images/betweenness-degree.svg?sanitize=true)

Species with densely connected social networks are unlikely to be very betweenness-central because their cohabitants can communicate with each other directly.
The probability that two of a species' cohabitants also cohabitate is given by the *transitivity* (or *[clustering coefficient](https://en.wikipedia.org/wiki/Clustering_coefficient#Local_clustering_coefficient)*) of the corresponding vertex.
This probability is easily calculable with the `igraph` package:

```r
pokemon$transitivity <- transitivity(net, type="local")
```

The chart below plots species' betweenness centralities against their transitivity within the cohabitation network.
The two attributes share a strong, negative and convex relationship.
Species whose cohabitants also cohabitate are less betweenness-central because they lack exclusive control of their cohabitants' communication channels.

The exceptions to this trend are Cubone and Pikachu, which have unusually high and low betweenness centralities, respectively.
Pikachu habitate in two locations, Viridian Forest and the Kanto Power Plant, each of which contain a small number of species that very frequently cohabitate and that generally have much higher degree centralities.
As a result, Pikachu have an unusually low betweenness centrality because their cohabitants are able to communicate with each other directly and with other species indirectly through their wider social networks.

![](https://raw.githubusercontent.com/bldavies/pokenet/master/images/betweenness-transitivity.svg?sanitize=true)

## The cocontainment network

I recycle my approach to analysing the cohabitation network among species in order to analyse the cocontainment network among locations.
In the latter network, two locations are adjacent if and only if they contain a common species.
I generate the cocontainment network from a binary location-location adjacency matrix as follows.

```r
cocontains <- t(habits) %*% habits
cocontains <- pmin(cocontains, 1)  # Remove parallel edges
location_net <- graph.adjacency(cocontains, mode="undirected")
```

The graph `location_net` contains 542 (about 60.02%) of the 903 possible edges between its 43 vertices.
The degree centralities of these vertices are computed via

```r
locations$degree <- degree(location_net)
```

I also compute the average ubiquity of each location:

```r
locations$average_ubiquity <- colSums(habits * pokemon$ubiquity) / locations$diversity
```

The locations with the six highest average ubiquities are tabulated below.
Viridian City and Pallet Town have the least unique demographies; the few species that habitate in these locations tend to also habitate in many other locations.
That Viridian City's average ubiquity and degree centrality are similar suggests that its four habitants usually cohabitate.

Location | Average Ubiquity | Degree | Diversity
:--- | ---:| ---:| ---:
Viridian City | 21.25 | 25 | 4
Pallet Town | 18.40 | 25 | 5
Celadon City | 16.40 | 25 | 5
Cerulean City | 16.17 | 25 | 6
Cinnabar Island | 16.00 | 25 | 7
Route 1 | 16.00 | 24 | 2

Finally, I compute the betweenness centrality of each location via

```r
locations$betweenness <- betweenness(location_net)
```

The table below shows the top six most betweenness-central locations.
Route 10 appears to offer a valuable path through which species can efficiently transmit information.
This is likely due to the diversity of its contained species, and that Route 10 and 11 boast the highest degree centralities in the cocontainment network.
The Safari Zone, another highly diverse location, is also an important information relay.

Location | Betweenness | Degree | Diversity
:--- | ---:| ---:| ---:
Route 10 | 58.54 | 39 | 18
Safari Zone | 55.89 | 33 | 27
Route 11 | 23.03 | 39 | 15
Cerulean Cave | 20.28 | 31 | 28
Route 6 | 18.38 | 38 | 16
Sea Route 21 | 18.38 | 38 | 13

## Postscript

I have no doubt that many gems within the encounter data remain undiscovered.
Readers who want to keep digging can find the data at [the GitHub repository for this project](https://github.com/bldavies/pokenet).


---

[^prod-space]: This technique is based on [Hidalgo et al. (2007)](http://science.sciencemag.org/content/317/5837/482)'s method of representing the product space of internationally traded goods.

[^prim]: For example, consider applying a greedy algorithm such as [Prim's](https://en.wikipedia.org/wiki/Prim's_algorithm) to a cohabitation network that contains a large clique of species that cohabit in a single location along with several species that are spread across many different locations. The algorithm will first connect each species in the clique and then, in order to avoid creating cycles, branch out to connect the relatively weakly connected species until a spanning forest is formed. The resulting subgraph will be a MSF but will contain edges that have lower weights than some of the omitted edges in the clique.
